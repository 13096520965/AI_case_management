# 汇款记录状态说明

## 问题说明

**现象**：汇款记录中已有"已汇款"状态的金额1000元，但页面展示"已收回"还是0元。

**原因**：这是**设计行为**，不是bug。

## 汇款状态定义

系统支持三种汇款状态，每种状态有不同的含义和统计规则：

### 1. 待汇款 🟡

**含义**：计划中的汇款，尚未执行

**特点**：
- 表示预期的汇款计划
- 还没有实际汇出
- 不计入"已收回"金额

**使用场景**：
- 对方承诺的分期付款
- 计划中的回款
- 待执行的汇款安排

**示例**：
```
汇款日期：2024-12-01
金额：¥50,000
状态：待汇款
说明：对方承诺12月1日支付第一笔款项
```

### 2. 已汇款 🔵

**含义**：对方已经汇出，但我方尚未确认到账

**特点**：
- 对方声称已汇款
- 我方银行账户尚未确认收到
- **不计入"已收回"金额** ⚠️

**使用场景**：
- 对方提供了汇款凭证
- 等待银行到账确认
- 跨行转账延迟到账

**示例**：
```
汇款日期：2024-11-20
金额：¥1,000
状态：已汇款
说明：对方已提供转账凭证，等待银行确认
```

### 3. 已确认 ✅

**含义**：我方已确认收到款项

**特点**：
- 银行账户已到账
- 金额已核实无误
- **计入"已收回"金额** ✅

**使用场景**：
- 银行账户已收到款项
- 财务已核对确认
- 可以作为实际回收金额统计

**示例**：
```
汇款日期：2024-11-15
金额：¥50,000
状态：已确认
说明：已到账并核实，第一笔回款
```

## 统计规则

### 已收回金额计算

```
已收回 = SUM(状态为"已确认"的汇款记录金额)
```

**只有"已确认"状态的汇款才计入已收回金额！**

### 示例说明

假设有以下汇款记录：

| 日期 | 金额 | 状态 | 是否计入已收回 |
|------|------|------|----------------|
| 2024-11-15 | ¥50,000 | 已确认 | ✅ 是 |
| 2024-11-20 | ¥1,000 | 已汇款 | ❌ 否 |
| 2024-12-01 | ¥30,000 | 待汇款 | ❌ 否 |

**统计结果**：
- 标的总额：¥150,000
- 已收回：¥50,000（只统计"已确认"）
- 剩余：¥100,000
- 回收率：33.33%

## 为什么这样设计？

### 1. 财务准确性

只有确认到账的款项才能作为实际回收金额，避免：
- 虚报回收率
- 财务数据不准确
- 对方汇款失败或退回

### 2. 风险控制

"已汇款"状态可能存在风险：
- 汇款凭证可能造假
- 跨行转账可能失败
- 金额可能不符

### 3. 业务流程

符合实际业务流程：
```
待汇款 → 已汇款 → 已确认
  ↓         ↓         ↓
 计划     等待确认   实际到账
  ❌        ❌        ✅
```

## 操作指南

### 场景1：对方声称已汇款

1. 创建汇款记录，状态选择"已汇款"
2. 上传对方提供的汇款凭证（如有）
3. 等待银行到账
4. 确认到账后，编辑记录，将状态改为"已确认"

### 场景2：确认收到款项

1. 检查银行账户
2. 核对金额和付款方
3. 找到对应的汇款记录
4. 将状态从"已汇款"改为"已确认"
5. 系统自动更新"已收回"金额

### 场景3：计划未来汇款

1. 创建汇款记录，状态选择"待汇款"
2. 填写预期汇款日期
3. 到期后提醒对方汇款
4. 收到款项后改为"已确认"

## 状态转换流程

### 正常流程

```
待汇款 → 已汇款 → 已确认
```

### 可能的流程

```
待汇款 → 已确认（直接确认到账）
已汇款 → 待汇款（汇款失败，退回计划状态）
已汇款 → 已确认（确认到账）
```

### 不建议的操作

```
已确认 → 已汇款（已确认的不应该退回）
已确认 → 待汇款（已确认的不应该退回）
```

## 常见问题

### Q1：为什么"已汇款"不计入已收回？

**A**：因为"已汇款"只表示对方声称已汇款，我方尚未确认到账。只有确认到账的款项才能作为实际回收金额。

### Q2：如何快速确认到账？

**A**：
1. 在"汇款记录"标签页找到对应记录
2. 点击"编辑"按钮
3. 将状态改为"已确认"
4. 点击"保存"
5. 系统自动更新统计数据

### Q3：可以批量确认吗？

**A**：当前版本需要逐条确认。未来版本可能会添加批量操作功能。

### Q4：如果对方汇款金额不对怎么办？

**A**：
1. 保持状态为"已汇款"
2. 在备注中说明实际到账金额
3. 与对方沟通补齐差额
4. 确认全额到账后再改为"已确认"

### Q5：可以修改已确认的记录吗？

**A**：可以，但不建议。已确认的记录应该是准确的财务数据，随意修改可能导致统计错误。

## 最佳实践

### 1. 及时更新状态

- 收到汇款凭证 → 立即标记为"已汇款"
- 确认到账 → 立即标记为"已确认"
- 保持数据实时性

### 2. 详细记录备注

```
好的备注示例：
- "工商银行转账，凭证号：202411200001"
- "已到账，实际金额¥50,000，与约定一致"
- "跨行转账，预计2个工作日到账"

不好的备注示例：
- "已付"
- "OK"
- 空白
```

### 3. 定期核对

- 每周核对银行流水
- 将"已汇款"状态的记录与银行到账匹配
- 及时更新为"已确认"

### 4. 保留凭证

- 保存汇款凭证截图
- 记录银行流水号
- 便于后续核对和审计

## 技术实现

### 前端统计逻辑

```typescript
const summary = computed(() => {
  // 只统计"已确认"状态的汇款
  const confirmedPayments = payments.value.filter(p => p.status === '已确认')
  const recoveredAmount = confirmedPayments.reduce((sum, p) => sum + p.amount, 0)
  const remainingAmount = detailData.totalAmount - recoveredAmount
  
  return {
    totalAmount: detailData.totalAmount,
    recoveredAmount,
    remainingAmount
  }
})
```

### 后端统计逻辑

```javascript
// 只统计"已确认"状态的汇款
const recoveredAmount = await PaymentRecord.sumByCaseId(caseId, '已确认');
```

## 状态标签颜色

为了直观区分，系统使用不同颜色标识状态：

- 🟡 **待汇款**：黄色（Warning）- 提醒注意
- 🔵 **已汇款**：蓝色（Info）- 等待确认
- ✅ **已确认**：绿色（Success）- 已完成

## 总结

**"已汇款"状态不计入"已收回"金额是正确的设计行为**，目的是：

1. ✅ 确保财务数据准确性
2. ✅ 避免虚报回收率
3. ✅ 符合实际业务流程
4. ✅ 降低财务风险

**操作建议**：
- 收到对方汇款凭证 → 标记为"已汇款"
- 确认银行到账 → 立即改为"已确认"
- 只有"已确认"的款项才计入实际回收金额

这样可以确保系统中的"已收回"金额与实际财务状况完全一致。
