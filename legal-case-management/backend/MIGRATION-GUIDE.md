# 证据路径迁移指南

## 概述

本指南说明如何使用 `migrate-evidence-paths.js` 脚本将现有证据记录的文件路径从完整文件系统路径格式转换为相对HTTP路径格式。

## 为什么需要迁移？

在之前的实现中，证据文件的 `storage_path` 字段存储的是完整的文件系统路径，例如：
```
C:\Users\username\project\backend\uploads\evidence\file.pdf
```

这种格式无法直接用于HTTP访问。新的实现使用相对路径格式：
```
/uploads/evidence/file.pdf
```

这种格式可以直接拼接到API基础URL后面进行HTTP访问。

## 迁移前准备

### 1. 备份数据库

**强烈建议在运行迁移脚本前备份数据库！**

```bash
# 备份数据库文件
cp backend/database/legal_case.db backend/database/legal_case.db.backup
```

### 2. 确认文件位置

确保所有证据文件都在正确的位置：
```
backend/uploads/evidence/
```

### 3. 检查依赖

确保已安装所有必要的依赖：
```bash
cd backend
npm install
```

## 使用方法

### 模拟运行（推荐首次使用）

在实际修改数据库之前，建议先进行模拟运行以查看将要进行的更改：

```bash
cd backend
node migrate-evidence-paths.js --dry-run --verbose
```

参数说明：
- `--dry-run`: 仅模拟运行，不实际修改数据库
- `--verbose`: 显示详细日志，包括每条记录的处理过程

### 实际执行迁移

确认模拟运行结果无误后，执行实际迁移：

```bash
cd backend
node migrate-evidence-paths.js
```

如果需要查看详细日志：

```bash
cd backend
node migrate-evidence-paths.js --verbose
```

## 输出说明

### 正常输出示例

```
============================================================
证据路径迁移脚本
============================================================
⚠ 运行模式: 实际修改数据库
============================================================

[2024-11-19T10:30:00.000Z] [INFO] 开始迁移证据路径...
[2024-11-19T10:30:00.100Z] [INFO] 找到 15 条证据记录

------------------------------------------------------------
证据表迁移结果:
  ✓ 成功: 12
  ✗ 失败: 0
  ○ 跳过: 3
------------------------------------------------------------

[2024-11-19T10:30:01.000Z] [INFO] 开始迁移证据版本历史路径...
[2024-11-19T10:30:01.100Z] [INFO] 找到 5 条版本记录

------------------------------------------------------------
版本历史表迁移结果:
  ✓ 成功: 4
  ✗ 失败: 0
  ○ 跳过: 1
------------------------------------------------------------

============================================================
总体迁移结果:
  ✓ 总成功: 16
  ✗ 总失败: 0
  ○ 总跳过: 4
============================================================

✓ 迁移完成！
```

### 状态说明

- **✓ 成功**: 路径成功转换并更新到数据库
- **✗ 失败**: 路径转换或数据库更新失败
- **○ 跳过**: 路径已经是相对格式，无需转换

### 警告信息

脚本可能会显示以下警告：

1. **无法在路径中找到 'uploads' 目录**
   - 原因：路径格式异常，无法识别
   - 处理：该记录将被跳过，需要手动检查

2. **文件不存在或无法访问**
   - 原因：数据库记录存在，但文件已被删除
   - 处理：路径仍会被转换，但需要注意文件缺失

## 验证迁移结果

### 1. 检查数据库

使用数据库工具查看 `evidence` 表的 `storage_path` 字段：

```sql
SELECT id, file_name, storage_path FROM evidence LIMIT 10;
```

确认路径格式为：`/uploads/evidence/filename.ext`

### 2. 测试文件访问

运行测试脚本验证文件可以正常访问：

```bash
cd backend
node test-evidence-preview-fix.js
```

### 3. 前端测试

1. 启动后端服务：
   ```bash
   cd backend
   npm start
   ```

2. 启动前端服务：
   ```bash
   cd frontend
   npm run dev
   ```

3. 在浏览器中测试：
   - 打开证据管理页面
   - 检查缩略图是否正常显示
   - 点击预览按钮，确认文件可以正常预览
   - 测试下载功能

## 故障排除

### 问题1: 迁移失败，部分记录更新失败

**可能原因**：
- 数据库权限问题
- 路径格式异常

**解决方法**：
1. 使用 `--verbose` 参数查看详细日志
2. 检查失败记录的原始路径格式
3. 必要时手动修正异常记录

### 问题2: 文件无法访问警告

**可能原因**：
- 文件已被删除
- 文件位置不正确

**解决方法**：
1. 检查 `backend/uploads/evidence/` 目录
2. 确认文件是否存在
3. 如果文件确实丢失，考虑删除对应的数据库记录

### 问题3: 迁移后前端仍无法预览

**可能原因**：
- 静态文件服务配置问题
- 前端代码未更新

**解决方法**：
1. 确认 `backend/src/app.js` 中的静态文件配置：
   ```javascript
   app.use('/uploads', express.static(path.join(__dirname, '../uploads')));
   ```

2. 确认前端 `getFileUrl` 函数已更新

3. 清除浏览器缓存并重新加载

## 回滚

如果迁移后出现问题，可以恢复备份：

```bash
# 停止后端服务
# 恢复数据库备份
cp backend/database/legal_case.db.backup backend/database/legal_case.db

# 重启后端服务
```

## 注意事项

1. **备份优先**：始终在迁移前备份数据库
2. **先模拟运行**：使用 `--dry-run` 参数先查看将要进行的更改
3. **停止服务**：建议在迁移期间停止后端服务，避免并发访问问题
4. **验证结果**：迁移完成后务必进行全面测试
5. **保留备份**：确认系统正常运行一段时间后再删除备份

## 技术细节

### 路径转换逻辑

脚本使用以下逻辑转换路径：

1. 检查路径是否已经是相对格式（以 `/uploads/` 开头）
2. 在完整路径中查找 `uploads` 目录的位置
3. 提取从 `uploads` 开始的路径部分
4. 标准化路径分隔符（将 `\` 转换为 `/`）
5. 确保路径以 `/` 开头

### 影响的表

脚本会迁移以下表的路径：

1. **evidence** - 主证据表
   - 字段：`storage_path`

2. **evidence_versions** - 证据版本历史表
   - 字段：`storage_path`

### 文件验证

脚本会验证转换后的路径是否可以访问文件：

```javascript
const absolutePath = path.join(__dirname, relativePath);
const isAccessible = fs.existsSync(absolutePath);
```

如果文件不存在，会显示警告但仍会更新路径格式。

## 支持

如果遇到问题，请：

1. 查看详细日志（使用 `--verbose` 参数）
2. 检查数据库备份是否完整
3. 确认文件系统权限
4. 联系技术支持团队

## 相关文档

- [证据预览功能修复设计文档](../.kiro/specs/evidence-preview-fix/design.md)
- [证据预览功能修复需求文档](../.kiro/specs/evidence-preview-fix/requirements.md)
- [测试脚本使用说明](./test-evidence-preview-fix.js)
