# 无效通知数据分析

## 问题描述

API 返回的通知数据中，某些通知的 `caseId` 和 `internalNumber` 为 `null`，`linkUrl` 为 `/cases/null`。

**示例数据**：
```json
{
  "id": 142,
  "relatedId": 24,
  "relatedType": "process_node",
  "taskType": "overdue",
  "scheduledTime": "2025-11-25T03:24:23.249Z",
  "content": "【超期警告】案件节点\"立案受理（更新）\"已超期 6 天（截止日期：2025-11-19 10:25:32），请尽快处理",
  "status": "read",
  "createdAt": "2025-11-25 03:24:23",
  "caseId": null,
  "internalNumber": null,
  "linkUrl": "/cases/null"
}
```

## 根本原因

这些通知是**无效数据**，原因是：

1. **关联的案件已被删除**：通知关联的节点（process_node）所属的案件已从数据库中删除
2. **孤立的节点数据**：节点仍然存在于数据库中，但其 `case_id` 指向一个不存在的案件
3. **数据不一致**：这是数据库中的数据一致性问题

## 数据分析

### 发现的无效通知

共找到 **10 条无效通知**，分别关联以下已删除的案件：

| 案件ID | 节点数量 | 通知数量 | 节点名称 |
|--------|--------|--------|--------|
| 14 | 4 | 4 | 立案受理、送达起诉状副本、庭前准备、送达判决书 |
| 16 | 4 | 4 | 立案受理、送达起诉状副本、庭前准备、送达判决书 |
| 17 | 2 | 1 | 立案受理（更新）、开庭审理（更新） |
| 32 | 1 | 1 | 节点1 |

### 无效通知的特征

- `caseId`: `null`
- `internalNumber`: `null`
- `linkUrl`: `/cases/null`
- 无法跳转到有效的案件详情页面

## 解决方案

### 1. 后端过滤（已实现）

在 `notificationController.js` 中添加了过滤逻辑：
- 检查关联的节点是否存在
- 检查节点所属的案件是否存在
- 过滤掉无效通知

```javascript
// 检查关联对象是否存在
if (nodeResult && nodeResult.length > 0) {
  caseInfo = {
    caseId: nodeResult[0].caseId,
    internalNumber: nodeResult[0].internal_number
  };
} else {
  // 标记为无效
  isValid = false;
}

// 过滤出有效的通知
const validNotifications = notificationsWithCase.filter(n => n.isValid !== false);
```

### 2. 数据清理（已执行）

运行清理脚本 `clean-invalid-notifications.js`：
- 删除了 10 条无效通知
- 清理后通知总数：13 条（从 23 条减少到 13 条）
- 清理后节点通知：10 条（从 20 条减少到 10 条）

### 3. 前端处理（已实现）

- 不显示 `caseId` 为 `null` 的通知
- 不显示 `linkUrl` 为 `/cases/null` 的链接
- 系统通知不显示案件编码

## 数据一致性建议

### 短期方案（已实现）
1. ✅ 后端过滤无效通知
2. ✅ 清理数据库中的无效通知
3. ✅ 前端不显示无效数据

### 长期方案（建议）
1. **添加外键约束**：在数据库中添加外键约束，防止删除有关联通知的案件
2. **级联删除**：删除案件时，自动删除相关的节点和通知
3. **数据验证**：定期检查数据一致性
4. **审计日志**：记录案件删除操作，便于追踪

## 清理结果

```
清理前：
- 总通知数: 23
- 系统通知: 1
- 节点通知: 20
- 费用通知: 0
- 无效通知: 10

清理后：
- 总通知数: 13
- 系统通知: 1
- 节点通知: 10
- 费用通知: 0
- 无效通知: 0
```

## 结论

**这些通知数据是无效的**，因为：
1. ✅ 关联的案件不存在
2. ✅ 无法获取案件编号
3. ✅ 无法跳转到有效的案件详情页面
4. ✅ 对用户没有实际价值

**已采取的措施**：
1. ✅ 后端过滤无效通知
2. ✅ 清理数据库中的无效数据
3. ✅ 前端不显示无效通知

**建议**：
- 定期运行清理脚本，保持数据一致性
- 考虑添加数据库约束，防止未来出现类似问题
