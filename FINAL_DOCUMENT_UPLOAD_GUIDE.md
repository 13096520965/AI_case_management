# 文书上传功能最终指南

## 问题修复总结

### 1. ✅ 中文文件名乱码问题已修复

**修复方法**：
- 后端使用 `Buffer.from(file.originalname, 'latin1').toString('utf8')` 转换编码
- 测试验证：中文文件名"测试文书-起诉状.txt"上传后正确显示

**注意**：
- 之前上传的乱码文件已被清理
- 新上传的文件不会再出现乱码

### 2. ✅ 预览功能已修复

**修复方法**：
- 修改了前端预览逻辑，正确处理不同类型的响应
- 支持文本文件（.txt）的在线预览
- 支持智能生成文书的预览

**预览支持**：
- ✅ 文本文件（.txt）：直接显示内容
- ✅ 智能生成的文书：显示生成的内容
- ⚠️ PDF、Word 文件：提示下载后查看（后续可增强）

### 3. ✅ 下载功能正常

**功能特点**：
- 支持所有文件类型的下载
- 中文文件名正确显示
- 自动设置正确的文件名

### 4. ✅ 删除功能正常

**功能特点**：
- 删除数据库记录
- 同时删除物理文件
- 带确认提示

### 5. ✅ 数据互通问题已修复

**修复方法**：
- 统一了 CaseDetail 和 DocumentManagement 页面的数据映射
- 两个页面现在显示相同的文书列表

## 使用指南

### 上传文书

1. 在案件详情页找到"文书材料"模块
2. 点击"上传文书"按钮
3. 选择文书类型
4. 选择文件（支持中文文件名）
5. 点击"上传"

**支持的文件格式**：
- PDF (.pdf)
- Word (.doc, .docx)
- 文本文件 (.txt)

**文件大小限制**：50MB

### 预览文书

1. 在文书列表中找到要预览的文书
2. 点击"预览"按钮
3. 在弹出的对话框中查看内容

**注意**：
- 文本文件可以直接预览
- PDF、Word 文件会提示下载后查看
- 智能生成的文书可以直接预览

### 下载文书

1. 在文书列表中找到要下载的文书
2. 点击"下载"按钮
3. 浏览器会自动下载文件

### 删除文书

1. 在文书列表中找到要删除的文书
2. 点击"删除"按钮
3. 确认删除
4. 文书从列表中消失，物理文件也被删除

## 测试验证

### 测试脚本

```bash
# 1. 清理乱码记录
node backend/clean-garbled-documents.js

# 2. 测试中文文件名上传
node backend/test-chinese-filename.js

# 3. 测试预览功能
node backend/test-preview.js

# 4. 测试完整上传流程
node backend/test-document-upload.js
```

### 浏览器测试

1. **测试中文文件名上传**
   - 准备一个中文文件名的文件，如"测试文书.txt"
   - 上传到系统
   - 验证列表中显示的文件名是否正确

2. **测试预览功能**
   - 上传一个文本文件
   - 点击"预览"按钮
   - 验证是否能看到文件内容

3. **测试下载功能**
   - 点击"下载"按钮
   - 验证下载的文件名是否正确
   - 验证文件内容是否完整

4. **测试数据互通**
   - 在案件详情页上传文书
   - 点击"查看详情"进入文书管理页面
   - 验证是否能看到刚才上传的文书

## 技术细节

### 文件名编码转换

```javascript
// 后端处理
const originalname = Buffer.from(req.file.originalname, 'latin1').toString('utf8');
```

### 预览逻辑

```javascript
// 前端处理
if (typeof response === 'string') {
  // 文本文件
  previewContent.value = response
} else if (response.data && response.data.content) {
  // 智能生成的文书
  previewContent.value = response.data.content
}
```

### 下载实现

```javascript
// 前端使用 fetch API 获取 blob
const blob = await documentApi.downloadDocument(doc.id)
const url = window.URL.createObjectURL(blob)
const link = document.createElement('a')
link.href = url
link.download = doc.fileName
link.click()
window.URL.revokeObjectURL(url)
```

## 已知限制

1. **预览功能**
   - PDF 文件不支持在线预览（需要集成 PDF.js）
   - Word 文件不支持在线预览（需要转换为 HTML）
   - 只支持文本文件的直接预览

2. **文件大小**
   - 最大 50MB
   - 大文件上传可能较慢

3. **文件类型**
   - 仅支持 PDF、Word、TXT 格式
   - 不支持图片、视频等其他格式

## 后续优化建议

1. **增强预览功能**
   - 集成 PDF.js 实现 PDF 在线预览
   - 支持 Word 文件转 HTML 预览
   - 支持图片预览

2. **上传体验优化**
   - 添加上传进度条
   - 支持拖拽上传
   - 支持批量上传

3. **文件管理增强**
   - 文件版本管理
   - 文件分享功能
   - 文件权限控制

4. **性能优化**
   - 大文件分片上传
   - 文件压缩
   - CDN 加速

## 故障排查

### 问题1：上传后文件名显示乱码

**解决方案**：
1. 确认后端服务已重启（加载新代码）
2. 清理旧的乱码记录：`node backend/clean-garbled-documents.js`
3. 重新上传文件

### 问题2：预览窗口闪现后消失

**原因**：文件类型不支持预览

**解决方案**：
- 查看浏览器控制台的错误信息
- 对于 PDF、Word 文件，使用下载功能

### 问题3：下载的文件名不正确

**解决方案**：
- 确认后端已正确处理文件名编码
- 检查浏览器的下载设置

### 问题4：文书管理页面看不到文书

**解决方案**：
- 确认前端代码已更新
- 刷新浏览器页面（Ctrl+F5 强制刷新）
- 检查浏览器控制台的错误信息

## 更新日期

2025-11-19

## 测试状态

- ✅ 中文文件名上传：通过
- ✅ 文件名编码转换：通过
- ✅ 预览功能（文本文件）：通过
- ✅ 下载功能：通过
- ✅ 删除功能：通过
- ✅ 数据互通：通过
