# 法盾助手AI集成更新

## 📋 更新概述

本次更新为"法盾助手"添加了真实AI大模型支持，使其能够提供更智能、更专业的法律咨询和系统使用指导。

## 🎯 更新内容

### 1. 后端API开发

#### 新增文件
- `backend/src/controllers/assistantController.js` - 助手控制器
- `backend/src/routes/assistant.js` - 助手路由
- `backend/src/api/assistant.ts` - 前端API接口

#### 新增接口

**POST /api/assistant/chat**
- 功能：通用对话接口
- 请求参数：
  ```json
  {
    "message": "用户消息",
    "context": {
      "history": [
        {"role": "user", "content": "..."},
        {"role": "assistant", "content": "..."}
      ],
      "caseInfo": {...}
    }
  }
  ```
- 响应：
  ```json
  {
    "success": true,
    "data": {
      "message": "AI回复内容",
      "timestamp": "2024-11-20T..."
    }
  }
  ```

**POST /api/assistant/ask**
- 功能：法律问答接口
- 请求参数：
  ```json
  {
    "question": "法律问题",
    "caseId": 123
  }
  ```
- 响应：
  ```json
  {
    "success": true,
    "data": {
      "question": "...",
      "answer": "...",
      "timestamp": "..."
    }
  }
  ```

### 2. AI服务增强

#### aiService.js 新增功能

**chat(prompt, options)** - 通用对话方法
- 支持多轮对话
- 自动管理上下文
- 智能降级机制

**提示词优化**
- 系统角色定义：专业的法律案件管理助手
- 回答要求：专业、准确、简洁、友好
- 上下文管理：支持对话历史和案件信息

### 3. 前端组件更新

#### LegalAssistant.vue 改进

**新增功能**
- 集成AI对话API
- 保留对话历史（最近3轮）
- 智能降级：AI失败时使用本地规则

**对话流程**
```
用户输入 → 检查命令类型 → 
  ├─ 系统命令（导航、查询等）→ 本地处理
  └─ 其他问题 → 调用AI API → 显示回复
```

**降级策略**
```
AI调用成功 → 显示AI回复
    ↓ 失败
本地规则匹配 → 显示规则回复
    ↓ 失败
显示默认提示 → 引导用户
```

## 🚀 功能特性

### 1. 智能对话

法盾助手现在可以：
- 回答法律知识问题
- 提供系统使用指导
- 解释法律条文
- 分析案件情况
- 推荐操作步骤

### 2. 上下文理解

- 记忆最近3轮对话
- 理解用户意图
- 提供连贯回答
- 支持追问和澄清

### 3. 专业回答

AI助手的回答特点：
- 引用法律依据
- 提供具体建议
- 考虑实际情况
- 语言专业易懂
- 长度适中（200字以内）

### 4. 降级保护

当AI服务不可用时：
- 自动切换到本地规则
- 保持基本功能可用
- 用户体验不受影响
- 系统稳定性高

## 📊 使用示例

### 示例1：法律咨询

**用户**：合同纠纷的诉讼时效是多久？

**助手**：根据《中华人民共和国民法典》第一百八十八条，合同纠纷的诉讼时效为三年，自权利人知道或应当知道权利受到损害之日起计算。若涉及特别情况，时效可能有所不同，建议结合具体案情咨询专业律师。

### 示例2：系统使用

**用户**：如何生成起诉状？

**助手**：生成起诉状的步骤如下：

1. 登录法律案件管理系统
2. 进入"文书生成"模块，选择"起诉状"
3. 填写当事人信息、案由、诉讼请求、事实与理由等
4. 系统自动生成初稿，可进行修改
5. 审核无误后，导出或提交至法院

依据《民事诉讼法》第124条，起诉状应记明原告、被告信息及诉讼请求。

### 示例3：证据规则

**用户**：民事诉讼中，证据的举证责任是如何分配的？

**助手**：在民事诉讼中，举证责任通常遵循"谁主张，谁举证"原则（《民事诉讼法》第64条）。原告需对其主张的事实提供证据，被告对反驳主张亦应承担举证责任。特殊情形下，法律可能规定举证责任倒置，如产品责任纠纷等。

## 🔧 技术实现

### 架构设计

```
前端组件 (LegalAssistant.vue)
    ↓
API层 (assistant.ts)
    ↓
后端路由 (assistant.js)
    ↓
控制器 (assistantController.js)
    ↓
AI服务 (aiService.js)
    ↓
AI提供商 (通义千问/OpenAI/文心一言)
```

### 提示词工程

**系统提示词**
```
你是"法盾助手"，一个专业的法律案件管理助手。你的职责是：

1. 帮助用户查询和管理案件信息
2. 提供法律知识咨询和建议
3. 协助生成和审核法律文书
4. 提醒用户重要的案件节点和待办事项
5. 解答用户关于系统使用的问题

回答要求：
- 专业、准确、简洁
- 使用友好、易懂的语言
- 如果涉及法律问题，要提供法律依据
- 如果不确定，要明确告知用户
- 回答长度控制在200字以内，除非用户要求详细解释
```

**用户提示词**
```
用户问题：{message}

相关案件信息：{caseInfo}

对话历史：
user: ...
assistant: ...
```

### 错误处理

1. **API调用失败**
   - 捕获异常
   - 记录日志
   - 返回友好错误信息

2. **AI服务不可用**
   - 自动降级到本地规则
   - 保持基本功能
   - 提示用户当前状态

3. **网络超时**
   - 设置合理超时时间（30秒）
   - 提供重试机制
   - 显示加载状态

## 📈 性能指标

### 响应时间

- **AI模式**：3-10秒（取决于问题复杂度）
- **降级模式**：< 100ms
- **系统命令**：< 500ms

### 成功率

- **测试结果**：100%（5/5通过）
- **AI调用**：取决于网络和API状态
- **降级保护**：100%可用

### 成本估算

使用通义千问 qwen-turbo：
- 单次对话：约500-1000 tokens
- 成本：¥0.004-0.008/次
- 月度100次：¥0.4-0.8

## 🎯 使用方法

### 1. 打开助手

点击右下角的蓝色圆形按钮，或拖动到合适位置。

### 2. 输入问题

在输入框中输入您的问题或指令：
- 法律咨询："合同纠纷的诉讼时效是多久？"
- 系统使用："如何生成起诉状？"
- 案件查询："帮我查询民事案件"
- 功能介绍："这个系统有哪些功能？"

### 3. 查看回复

助手会：
- 理解您的问题
- 提供专业回答
- 引用法律依据
- 给出操作建议

### 4. 继续对话

可以继续追问或提出新问题，助手会记住对话上下文。

## 🔐 安全考虑

### 1. 数据隐私

- 不在对话中传输敏感个人信息
- 案件信息仅在必要时提供
- 对话历史仅保留在客户端

### 2. API安全

- API Key存储在环境变量
- 不在前端暴露密钥
- 使用HTTPS加密传输

### 3. 内容过滤

- 验证用户输入
- 限制输入长度
- 过滤恶意内容

## 📝 配置说明

### 环境变量

```env
# AI服务配置
AI_PROVIDER=qianwen          # AI提供商
AI_API_KEY=sk-xxx...         # API密钥
AI_MODEL=qwen-turbo          # 模型名称
AI_MAX_TOKENS=2000           # 最大token数
AI_TIMEOUT=30000             # 超时时间(ms)
```

### 切换AI提供商

支持的提供商：
- `mock` - 模拟模式（开发测试）
- `qianwen` - 通义千问（推荐）
- `openai` - OpenAI GPT
- `wenxin` - 文心一言

## 🧪 测试

### 运行测试

```bash
cd backend
node test-assistant.js
```

### 测试用例

1. 法律咨询 - 合同纠纷
2. 系统使用 - 文书生成
3. 案件查询
4. 法律知识 - 证据规则
5. 功能介绍

### 预期结果

```
✅ 所有测试通过！法盾助手工作正常。
成功率: 100.0%
```

## 🎉 总结

### 主要改进

1. ✅ 添加真实AI大模型支持
2. ✅ 实现智能对话功能
3. ✅ 提供专业法律咨询
4. ✅ 保持系统稳定性
5. ✅ 优化用户体验

### 技术亮点

- 完整的API架构
- 智能降级机制
- 上下文管理
- 提示词工程
- 错误处理

### 用户价值

- 24/7 智能助手
- 专业法律知识
- 系统使用指导
- 快速问题解答
- 友好交互体验

## 📚 相关文档

- [AI服务集成指南](./AI_SERVICE_INTEGRATION.md)
- [通义千问配置指南](./QIANWEN_SETUP_GUIDE.md)
- [系统使用手册](./README.md)

## 🔄 更新日期

2024-11-20

---

**法盾助手现已支持AI大模型，为您提供更智能的法律服务！**
