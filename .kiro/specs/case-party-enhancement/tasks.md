# 案件主体信息展示与搜索增强实施任务清单

## 数据库增强

- [-] 1. 数据库表结构增强
  - [x] 1.1 为 litigation_parties 表添加 is_primary 字段
    - 执行 ALTER TABLE 添加 is_primary 字段（BOOLEAN类型，默认值0）
    - 为现有数据设置主要当事人（每个案件每个类型的第一个主体）
    - _需求: 需求 2.2, 7.3_
  
  - [x] 1.2 为 litigation_parties 表添加索引
    - 创建 idx_party_name 索引（name字段）
    - 创建 idx_party_case_id 索引（case_id字段）
    - 创建 idx_party_type 索引（party_type字段）
    - _需求: 需求 4.2, 4.3_
  
  - [x] 1.3 创建 party_history 表
    - 创建表结构（id, party_id, case_id, action, changed_fields, changed_by, changed_at）
    - 创建 idx_party_history_party_id 索引
    - _需求: 需求 5.4_
  
  - [x] 1.4 创建 party_templates 表
    - 创建表结构（id, name, entity_type, contact_phone, address, usage_count, last_used_at, created_at）
    - 创建 idx_party_template_name 索引
    - 添加 UNIQUE 约束（name, entity_type）
    - _需求: 需求 8.1, 8.2, 8.5_

## 后端API开发

- [-] 2. 案件查询API增强
  - [x] 2.1 增强案件列表查询接口
    - 修改 GET /api/cases 接口，使用 GROUP_CONCAT 按类型关联主体信息
    - 返回数据包含 plaintiffs、defendants、third_parties 三个数组
    - 支持 partyName 查询参数进行当事人搜索
    - _需求: 需求 2.1, 2.4, 4.3_
  
  - [x] 2.2 增强案件详情查询接口
    - 修改 GET /api/cases/:id 接口，返回按类型分组的主体信息
    - 包含每个主体的历史案件数量
    - _需求: 需求 1.1, 7.4, 7.5_

- [-] 3. 主体管理API增强
  - [x] 3.1 增强主体创建接口
    - 修改 POST /api/cases/:caseId/parties 接口
    - 支持批量创建多个主体（按类型）
    - 自动设置第一个主体为 is_primary
    - 记录创建历史到 party_history 表
    - _需求: 需求 1.4, 5.4_
  
  - [x] 3.2 增强主体更新接口
    - 修改 PUT /api/parties/:id 接口
    - 记录变更字段到 party_history 表
    - 包含修改人和修改时间
    - _需求: 需求 1.5, 5.4_
  
  - [x] 3.3 增强主体删除接口
    - 修改 DELETE /api/parties/:id 接口
    - 检查主体是否被其他案件引用
    - 如果被多个案件引用，只删除关联关系
    - 记录删除历史
    - _需求: 需求 5.2, 5.3_

- [x] 4. 主体搜索API
  - [x] 4.1 实现搜索建议接口
    - 创建 GET /api/parties/suggestions 接口
    - 支持 keyword 和 partyType 参数
    - 返回匹配的主体名称和案件数量
    - 按案件数量降序排序，限制10条
    - _需求: 需求 4.2, 8.1_
  
  - [x] 4.2 实现主体历史信息接口
    - 创建 GET /api/parties/:id/history 接口
    - 返回主体基本信息和历史案件列表
    - _需求: 需求 7.5_
  
  - [x] 4.3 实现主体模板查询接口
    - 创建 GET /api/parties/templates/:name 接口
    - 从 party_templates 表查询
    - 如果不存在，从 litigation_parties 表查询最近记录
    - 更新使用统计
    - _需求: 需求 8.2, 8.5_

- [-] 5. 批量导入API
  - [x] 5.1 实现导入接口
    - 创建 POST /api/parties/import 接口
    - 使用 Multer 处理文件上传
    - 支持 Excel 和 CSV 格式
    - 支持 importMode 参数（multi-sheet / single-sheet）
    - _需求: 需求 3.1, 3.2_
  
  - [x] 5.2 实现多sheet导入处理逻辑
    - 解析"原告信息"、"被告信息"、"第三人信息" sheet
    - 按sheet确定主体类型
    - 验证必填字段（案件编号、主体名称）
    - _需求: 需求 3.3_
  
  - [x] 5.3 实现单sheet导入处理逻辑
    - 解析包含"主体类型"列的数据
    - 验证主体类型值的有效性
    - _需求: 需求 3.3, 5.5_
  
  - [x] 5.4 实现导入验证和错误处理
    - 验证案件是否存在
    - 检查重复主体（案件+名称+类型）
    - 返回详细错误信息（sheet、行号、字段、错误消息）
    - 返回按类型统计的结果摘要
    - _需求: 需求 3.4, 3.6_
  
  - [x] 5.5 实现重复数据处理
    - 检测重复主体
    - 提供更新或跳过选项
    - _需求: 需求 3.5_
  
  - [x] 5.6 实现导入模板下载接口
    - 创建 GET /api/parties/import/template 接口
    - 生成包含三个sheet的Excel模板
    - 包含示例数据和字段说明
    - _需求: 需求 3.7_

- [x] 6. 导出API增强
  - [x] 6.1 增强案件导出接口
    - 修改 GET /api/cases/export 接口
    - 支持 includeParties 参数
    - 支持 exportMode 参数（multi-sheet / single-sheet）
    - 支持 format 参数（xlsx / csv）
    - _需求: 需求 6.1, 6.2, 6.3_
  
  - [x] 6.2 实现多sheet导出逻辑
    - 按主体类型创建三个sheet
    - 每个sheet包含案件信息和对应类型的主体信息
    - _需求: 需求 6.4_
  
  - [x] 6.3 实现单sheet导出逻辑
    - 创建包含主体类型列的单sheet
    - 每个主体一行
    - _需求: 需求 6.4_
  
  - [x] 6.4 实现选择性导出
    - 支持 caseIds 参数
    - 只导出选中的案件及其主体
    - _需求: 需求 6.5_

- [ ] 7. Checkpoint - 确保后端测试通过
  - 确保所有后端API测试通过，如有问题请询问用户

## 前端组件开发

- [ ] 8. 案件列表组件增强
  - [ ] 8.1 修改案件列表表格结构
    - 添加"原告"、"被告"、"第三人"三列
    - 每列使用不同颜色的标签（原-红色、被-黄色、三-灰色）
    - 实现多主体显示格式（"主体名称 等N人"）
    - _需求: 需求 2.1, 2.2, 7.1, 7.3_
  
  - [ ] 8.2 实现主体信息提示框
    - 鼠标悬停显示完整主体列表
    - 包含主体名称、联系方式等详细信息
    - _需求: 需求 2.3_
  
  - [ ] 8.3 实现主体名称点击跳转
    - 点击主体名称跳转到主体详细档案页面
    - _需求: 需求 2.5_
  
  - [ ] 8.4 实现长文本截断
    - 主体名称超过20字符自动截断
    - 显示省略号
    - 完整内容通过提示框展示
    - _需求: 需求 7.2_

- [ ] 9. 案件基本信息表单组件增强
  - [ ] 9.1 创建按类型分区的表单布局
    - 使用 el-divider 分隔原告、被告、第三人区域
    - 每个区域使用不同颜色的标签标识
    - _需求: 需求 1.2_
  
  - [ ] 9.2 实现原告信息录入区域
    - 支持添加多个原告
    - 每个原告包含：实体类型、名称、联系电话、地址
    - 提供"添加原告"按钮
    - 提供删除按钮（至少保留一个）
    - _需求: 需求 1.3, 1.5_
  
  - [ ] 9.3 实现被告信息录入区域
    - 支持添加多个被告
    - 字段和功能同原告区域
    - _需求: 需求 1.3, 1.5_
  
  - [ ] 9.4 实现第三人信息录入区域（可选）
    - 支持添加多个第三人
    - 字段和功能同原告区域
    - 所有第三人都可删除
    - _需求: 需求 1.3, 1.5_
  
  - [ ] 9.5 实现主体名称自动补全
    - 集成 el-autocomplete 组件
    - 按主体类型获取搜索建议
    - 显示主体名称和案件数量
    - _需求: 需求 8.1_
  
  - [ ] 9.6 实现历史主体自动填充
    - 选择历史主体后自动填充联系方式、地址等字段
    - 调用主体模板接口获取数据
    - _需求: 需求 8.2_
  
  - [ ] 9.7 实现表单验证
    - 验证必填字段（主体类型、主体名称、联系方式）
    - 验证主体类型只能是预定义值
    - 显示验证错误信息
    - _需求: 需求 1.3, 5.5_
  
  - [ ] 9.8 实现表单提交
    - 合并所有类型的主体数据
    - 调用案件创建/更新接口
    - 同时保存案件和主体信息
    - _需求: 需求 1.4_

- [ ] 10. 案件详情页面增强
  - [ ] 10.1 实现按类型分组展示主体
    - 按原告、被告、第三人分组显示
    - 每组使用卡片或列表展示
    - _需求: 需求 1.1, 7.4_
  
  - [ ] 10.2 显示主体历史案件数量
    - 在每个主体旁边显示历史案件数量
    - 点击可查看历史案件列表
    - _需求: 需求 7.5_
  
  - [ ] 10.3 实现主体编辑功能
    - 支持在详情页直接编辑主体信息
    - 调用主体更新接口
    - _需求: 需求 1.5_
  
  - [ ] 10.4 实现主体删除功能
    - 支持删除主体
    - 显示删除确认对话框
    - 如果被多个案件引用，提示用户
    - _需求: 需求 1.5, 5.2, 5.3_

- [ ] 11. 搜索组件增强
  - [ ] 11.1 添加当事人搜索字段
    - 在搜索表单中添加"当事人"输入框
    - 使用 el-autocomplete 组件
    - _需求: 需求 4.1_
  
  - [ ] 11.2 实现搜索建议
    - 输入关键词时实时获取建议
    - 显示主体名称和案件数量
    - _需求: 需求 4.2_
  
  - [ ] 11.3 实现搜索结果高亮
    - 搜索结果中高亮显示匹配的当事人名称
    - 使用不同背景色或字体颜色
    - _需求: 需求 4.4_
  
  - [ ] 11.4 实现组合搜索
    - 支持当事人与案号、案由、日期等条件的联合查询
    - 所有条件使用 AND 逻辑
    - _需求: 需求 4.5_
  
  - [ ] 11.5 实现搜索条件清空
    - 提供"清空"按钮
    - 清空后恢复显示完整列表
    - _需求: 需求 4.6_

- [ ] 12. 批量导入组件
  - [ ] 12.1 创建导入对话框组件
    - 使用 el-dialog 创建对话框
    - 包含文件上传区域和结果展示区域
    - _需求: 需求 3.1, 3.2_
  
  - [ ] 12.2 实现文件上传功能
    - 使用 el-upload 组件
    - 支持拖拽上传
    - 限制文件类型（.xlsx, .csv）
    - 限制文件大小（如10MB）
    - _需求: 需求 3.1, 3.2_
  
  - [ ] 12.3 实现导入模式选择
    - 提供单选按钮选择导入模式
    - 多sheet模式（推荐）
    - 单sheet模式
    - _需求: 需求 3.1, 3.2_
  
  - [ ] 12.4 实现导入进度显示
    - 显示上传进度条
    - 显示处理状态（验证中、导入中）
    - _需求: 需求 3.6_
  
  - [ ] 12.5 实现导入结果展示
    - 显示总数、成功数、失败数
    - 按主体类型显示统计（原告、被告、第三人）
    - 显示错误列表（sheet、行号、字段、错误消息）
    - 支持导出错误列表
    - _需求: 需求 3.4, 3.6_
  
  - [ ] 12.6 实现模板下载功能
    - 提供"下载模板"按钮
    - 调用模板下载接口
    - 自动下载Excel文件
    - _需求: 需求 3.7_
  
  - [ ] 12.7 实现重复数据处理选项
    - 当检测到重复时，显示选项对话框
    - 提供"跳过"和"更新"选项
    - _需求: 需求 3.5_

- [ ] 13. 导出功能增强
  - [ ] 13.1 添加导出选项对话框
    - 创建导出配置对话框
    - 包含导出模式选择（多sheet / 单sheet）
    - 包含格式选择（Excel / CSV）
    - 包含是否包含主体信息选项
    - _需求: 需求 6.1, 6.2, 6.3_
  
  - [ ] 13.2 实现全部导出功能
    - 调用导出接口
    - 传递当前筛选条件
    - 自动下载文件
    - _需求: 需求 6.4, 6.6_
  
  - [ ] 13.3 实现选择性导出功能
    - 支持勾选案件
    - 只导出选中的案件
    - 传递 caseIds 参数
    - _需求: 需求 6.5_

- [ ] 14. 主体详细档案页面
  - [ ] 14.1 创建主体档案页面
    - 显示主体基本信息
    - 显示历史案件列表
    - 显示修改历史
    - _需求: 需求 2.5, 7.5_
  
  - [ ] 14.2 实现历史案件列表
    - 显示该主体参与的所有案件
    - 显示在每个案件中的角色（原告/被告/第三人）
    - 支持点击跳转到案件详情
    - _需求: 需求 7.5_
  
  - [ ] 14.3 实现修改历史展示
    - 显示主体信息的修改记录
    - 包含修改人、修改时间、变更字段
    - 使用时间轴展示
    - _需求: 需求 5.4_

- [ ] 15. Checkpoint - 确保前端测试通过
  - 确保所有前端组件测试通过，如有问题请询问用户

## 测试开发

- [ ] 16. 后端单元测试
  - [ ] 16.1 测试案件查询包含主体信息
    - 测试返回数据包含 plaintiffs、defendants、third_parties
    - 测试空主体情况
    - 测试多主体情况
    - _需求: 需求 2.1, 2.4_
  
  - [ ] 16.2 测试批量导入验证
    - 测试缺少必填字段的拒绝
    - 测试无效主体类型的拒绝
    - 测试案件不存在的错误
    - 测试重复主体的处理
    - _需求: 需求 3.3, 3.4, 3.5_
  
  - [ ] 16.3 测试级联删除
    - 测试删除案件时主体被删除
    - 测试删除主体时的引用检查
    - _需求: 需求 5.1, 5.2, 5.3_
  
  - [ ] 16.4 测试搜索功能
    - 测试按当事人名称搜索
    - 测试搜索建议生成
    - 测试组合搜索
    - _需求: 需求 4.2, 4.3, 4.5_

- [ ] 17. 前端单元测试
  - [ ] 17.1 测试案件列表组件
    - 测试主体信息展示
    - 测试多主体显示格式
    - 测试提示框显示
    - _需求: 需求 2.1, 2.2, 2.3_
  
  - [ ] 17.2 测试表单组件
    - 测试按类型添加主体
    - 测试表单验证
    - 测试自动补全
    - 测试自动填充
    - _需求: 需求 1.3, 8.1, 8.2_
  
  - [ ] 17.3 测试导入组件
    - 测试文件格式验证
    - 测试导入结果展示
    - 测试错误列表显示
    - _需求: 需求 3.3, 3.4, 3.6_

- [ ] 18. 属性测试
  - [ ] 18.1 属性3: 数据持久化一致性
    - 生成随机案件和主体数据
    - 保存后立即查询
    - 验证数据一致性
    - 运行100次迭代
    - **Feature: case-party-enhancement, Property 3: 数据持久化一致性（Round-trip）**
    - **验证需求: 1.4**
  
  - [ ] 18.2 属性7: 导入结果完整性
    - 生成随机导入文件
    - 执行导入
    - 验证 success + failed = total
    - 运行100次迭代
    - **Feature: case-party-enhancement, Property 7: 导入结果完整性**
    - **验证需求: 3.6**
  
  - [ ] 18.3 属性8: 搜索结果准确性
    - 生成随机当事人名称
    - 执行搜索
    - 验证所有结果都包含该当事人
    - 运行100次迭代
    - **Feature: case-party-enhancement, Property 8: 搜索结果准确性**
    - **验证需求: 4.3**
  
  - [ ] 18.4 属性10: 级联删除完整性
    - 生成随机案件和主体
    - 删除案件
    - 验证主体也被删除
    - 运行100次迭代
    - **Feature: case-party-enhancement, Property 10: 级联删除完整性**
    - **验证需求: 5.1**
  
  - [ ] 18.5 属性13: 类型约束
    - 生成随机无效类型
    - 尝试创建主体
    - 验证系统拒绝
    - 运行100次迭代
    - **Feature: case-party-enhancement, Property 13: 类型约束**
    - **验证需求: 5.5**

- [ ] 19. 集成测试
  - [ ] 19.1 测试完整导入流程
    - 上传文件 → 验证 → 导入 → 查看结果
    - _需求: 需求 3.1-3.7_
  
  - [ ] 19.2 测试搜索到详情流程
    - 搜索当事人 → 查看列表 → 点击案件 → 查看详情
    - _需求: 需求 4.1-4.6, 2.5_
  
  - [ ] 19.3 测试编辑流程
    - 打开案件 → 添加主体 → 保存 → 验证显示
    - _需求: 需求 1.1-1.5_
  
  - [ ] 19.4 测试导出流程
    - 筛选案件 → 导出 → 验证文件内容
    - _需求: 需求 6.1-6.6_

- [ ] 20. 性能测试
  - [ ] 20.1 测试案件列表加载性能
    - 创建1000条案件记录（包含主体）
    - 测试列表加载时间 < 500ms
    - _需求: 需求 2.4_
  
  - [ ] 20.2 测试搜索响应时间
    - 测试搜索响应时间 < 200ms
    - _需求: 需求 4.2_
  
  - [ ] 20.3 测试批量导入性能
    - 导入1000条记录
    - 测试导入时间 < 5s
    - _需求: 需求 3.6_
  
  - [ ] 20.4 测试导出性能
    - 导出1000条记录
    - 测试导出时间 < 3s
    - _需求: 需求 6.6_

## 文档和部署

- [ ] 21. API文档更新
  - 更新API文档，添加新增和修改的接口说明
  - 包含请求参数、响应格式、错误码说明
  - _需求: 需求 1-8_

- [ ] 22. 用户手册更新
  - 编写主体信息管理功能使用说明
  - 编写批量导入操作指南
  - 编写搜索功能使用说明
  - _需求: 需求 1-8_

- [ ] 23. 数据库迁移脚本
  - 编写完整的数据库迁移SQL脚本
  - 编写回滚脚本
  - 测试迁移脚本
  - _需求: 需求 1-8_

- [ ] 24. 部署准备
  - 更新前端依赖（xlsx）
  - 测试生产环境构建
  - 准备部署文档
  - _需求: 需求 1-8_

- [ ] 25. Final Checkpoint - 完整功能验证
  - 在测试环境进行完整功能验证
  - 确保所有需求都已实现
  - 确保所有测试通过
  - 询问用户是否可以部署到生产环境
