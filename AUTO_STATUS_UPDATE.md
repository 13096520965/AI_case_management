# 自动状态更新功能

## 功能概述

实现了两个自动化逻辑，简化案件管理流程：

1. **节点自动完成**：当节点进度设置为 100% 时，自动将节点状态标记为"已完成"
2. **案件自动结案**：当案件的所有节点都标记为"已完成"时，自动将案件状态标记为"已结案"

## 功能详情

### 1. 节点自动完成

**触发条件**：
- 节点进度被更新为 100%
- 节点当前状态不是"已完成"

**自动操作**：
- 将节点状态自动设置为"已完成"
- 记录操作日志，标注为自动变更

**示例**：
```
用户操作：将"立案审查"节点进度从 80% 更新为 100%
系统自动：将"立案审查"节点状态从"进行中"更新为"已完成"
日志记录：节点"立案审查"进度达到100%，自动标记为已完成
```

### 2. 案件自动结案

**触发条件**：
- 案件至少有一个流程节点
- 案件的所有流程节点状态都是"已完成"
- 案件当前状态不是"已结案"

**自动操作**：
- 将案件状态自动设置为"已结案"
- 记录案件状态变更日志，标注为自动结案

**示例**：
```
案件节点状态：
- 立案审查：已完成 ✓
- 证据收集：已完成 ✓
- 开庭审理：已完成 ✓
- 判决执行：已完成 ✓

系统自动：将案件状态从"进行中"更新为"已结案"
日志记录：所有流程节点已完成，案件自动标记为已结案
```

## 使用场景

### 场景1：完成单个节点

1. 用户在案件详情页找到某个节点
2. 将节点进度拖动到 100%
3. 点击保存

**系统自动**：
- ✅ 节点状态变为"已完成"
- ✅ 记录日志
- ✅ 检查是否所有节点都已完成
- ✅ 如果是，案件自动结案

### 场景2：批量完成节点

1. 用户依次完成多个节点
2. 每个节点进度设置为 100%

**系统自动**：
- ✅ 每个节点自动标记为"已完成"
- ✅ 当最后一个节点完成时，案件自动结案

### 场景3：手动设置状态

用户也可以手动设置节点状态为"已完成"，不会影响自动化逻辑。

## 技术实现

### 后端逻辑

```javascript
// 1. 进度达到100%时自动标记为已完成
if (updateData.progress === 100 && existingNode.status !== '已完成') {
  updateData.status = '已完成';
}

// 2. 检查所有节点是否都已完成
const allNodes = await ProcessNode.findByCaseId(existingNode.case_id);
const allCompleted = allNodes.every(node => node.status === '已完成');

if (allCompleted && allNodes.length > 0) {
  const caseData = await Case.findById(existingNode.case_id);
  if (caseData && caseData.status !== '已结案') {
    await Case.update(existingNode.case_id, { status: '已结案' });
  }
}
```

### 日志记录

系统会自动记录以下日志：

1. **节点进度变更日志**
   - 操作类型：`NODE_PROGRESS_CHANGE`
   - 描述：节点进度从 X% 更新为 Y%

2. **节点状态变更日志**
   - 操作类型：`NODE_STATUS_CHANGE`
   - 描述：节点自动标记为已完成（如果是自动变更）
   - 标记：`auto_changed: true`

3. **案件状态变更日志**
   - 操作类型：`CASE_STATUS_CHANGE`
   - 描述：所有流程节点已完成，案件自动标记为已结案
   - 标记：`auto_closed: true`

## 测试验证

### 测试步骤

1. **测试节点自动完成**
   ```
   1. 进入案件详情页
   2. 找到一个进行中的节点
   3. 将进度拖动到 100%
   4. 点击保存
   5. 验证节点状态是否自动变为"已完成"
   ```

2. **测试案件自动结案**
   ```
   1. 创建一个新案件
   2. 添加几个流程节点
   3. 依次将每个节点进度设置为 100%
   4. 当最后一个节点完成时
   5. 验证案件状态是否自动变为"已结案"
   ```

3. **测试日志记录**
   ```
   1. 完成上述操作
   2. 进入案件日志页面
   3. 验证是否有自动变更的日志记录
   ```

### 预期结果

- ✅ 节点进度达到 100% 时自动标记为已完成
- ✅ 所有节点完成时案件自动结案
- ✅ 日志正确记录自动变更
- ✅ 用户界面实时更新

## 边界情况处理

### 1. 没有节点的案件

如果案件没有任何流程节点，不会自动结案。

### 2. 部分节点完成

只有当**所有**节点都完成时，案件才会自动结案。

### 3. 手动修改状态

用户可以手动将节点状态改回"进行中"，这不会影响自动化逻辑。

### 4. 进度回退

如果用户将已完成节点的进度改为小于 100%，状态不会自动改变（需要手动修改）。

### 5. 案件重新开启

如果案件已结案，用户可以手动将状态改回"进行中"，这不会影响自动化逻辑。

## 优势

1. **减少手动操作**
   - 不需要手动设置节点状态
   - 不需要手动标记案件结案

2. **提高准确性**
   - 避免忘记更新状态
   - 确保状态与进度一致

3. **提升效率**
   - 自动化流程
   - 减少重复操作

4. **完整的审计追踪**
   - 所有自动变更都有日志记录
   - 可以追溯变更历史

## 注意事项

1. **进度与状态的关系**
   - 进度 = 100% → 自动标记为已完成
   - 进度 < 100% → 不会自动改变状态

2. **案件结案条件**
   - 必须所有节点都是"已完成"
   - 至少要有一个节点

3. **日志标记**
   - 自动变更的日志会标记 `auto_changed: true` 或 `auto_closed: true`
   - 可以区分手动操作和自动操作

## 后续优化建议

1. **通知功能**
   - 节点自动完成时发送通知
   - 案件自动结案时发送通知

2. **规则配置**
   - 允许管理员配置自动化规则
   - 可以开启/关闭自动化功能

3. **批量操作**
   - 支持批量设置节点进度
   - 批量完成节点

4. **智能提醒**
   - 当所有节点接近完成时提醒用户
   - 预测案件结案时间

## 更新日期

2025-11-19

## 修改的文件

- `backend/src/controllers/processNodeController.js`
